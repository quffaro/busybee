#!/bin/bash

usage() { echo "Usage: $0 [-m]" 1>&2; exit 1; }

buildrepo=$(tomlq '.targets.forester.repo' config.toml | tr -d '"')
buildtgt=$(tomlq '.targets.forester.tgt' config.toml | tr -d '"')
buildcmd=$(tomlq '.targets.forester.builder' config.toml | tr -d '"')

while getopts "ms" o; do
    case "${o}" in
        m)
            m=1
            ;;
		s)
			tgt="drafts"
			;;
        *)
            usage
            ;;
    esac
done
shift $((OPTIND-1))

tgt="${tgt:-public}"
grepstr="^posts/**/${tgt}.*\.pm$"

# TODO CONFIG TOML SHOULD TELL US WHERE POSTS ARE
echo "growing trees in flower directory"
cd "$BBHOME/src"
raco pollen render -t tree posts/public/*.poly.pm

# move files to forester or other publishing target
fd -e '.tree' --search-path posts/public -x mv {} "$buildrepo/$buildtgt/"

# execute build step
echo "building..."
cd $buildrepo
command $buildcmd
